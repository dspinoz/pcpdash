<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>PCPDash</title>
    <script src='/jquery.js' type='text/javascript'></script>
    <script src='/bootstrap.js' type='text/javascript'></script>
    <link href='/bootstrap.css' rel='stylesheet' type='text/css'>
    
    <script src="/d3.js"></script>
    <script src="/queue.js"></script>
    
    <script type="text/javascript">
    

      function d3barchart() {
        
        var width = 720, // default width
            height = 500; // default height

        function my(selection) {
          selection.each(function(d, i) {
            // generate chart here; `d` is the data and `this` is the element
             selection.text("abc " + width + "," + height);
          });
        }
        
        my.width = function(value) {
          if (!arguments.length) return width;
          width = value;
          return my;
        };

        my.height = function(value) {
          if (!arguments.length) return height;
          height = value;
          return my;
        };

        return my;
      }
    
    
    </script>
    
    <style type="text/css">
      
      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .bar {
        fill: steelblue;
      }
      
      .bar:hover {
        fill: LightSlateGray;
      }
      
    </style> 
  </head>

  <body>
    
    <!-- Static navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">PCPDash</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/index.html">Getting Started</a></li>
            <li class="active"><a href="/load.html">System Load</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    
    <div class='container' style='font: 12px sans-serif;'>
      <div class='row'>
        <div class='span12'>

          <div id="reusable"></div>
          <div id="barchart"></div>
          
          <div class='container' id='content'></div>
          
          <button type="button" class="btn btn-default btn-lg" onclick="updateData()">
            <span class="glyphicon glyphicon-refresh"></span> Update
          </button>

        </div>
      </div>
    </div>
    
    <script type="text/javascript">
      var bc = d3barchart();
      console.log('d3barchart', bc.width(), bc.height());
      d3.select('#reusable').call(bc);
    
    
      var margin = {top: 20, right: 20, bottom: 100, left: 40},
          width = 960 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

      var xValue = function(d) { return d.value.name; }, // data -> value
          xScale = d3.scale.ordinal().rangeRoundBands([0, width], .1), // value -> display
          xMap = function(d) { return xScale(xValue(d)); }, // data -> display
          xAxis = d3.svg.axis().scale(xScale).orient("bottom");

      var yValue = function(d) { return d.value.value; }, // data -> value
          yScale = d3.scale.linear().range([height, 0]), // value -> display
          yMap = function(d) { return yScale(yValue(d)); }, // data -> display
          yAxis = d3.svg.axis().scale(yScale).orient("left"),
          yAxisLabel = function(d) { return "Value"; };

      var svg = d3.select("#barchart").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
          
      
      function getContext(info, callback)
      {
        d3.json("/pmapi/context?local=ANYTHING", function(json) {
          
          info.context = json.context;
          
          info.queue.defer(getMetric, info);
          
          callback(null,null);
        });
      }
      
      function getMetric(info, callback) {
        //TODO support multiple metrics
        d3.json("/pmapi/"+info.context+"/_metric?prefix="+info.metric, function(json) {
          
          info.metric = json.metrics[0];
          
          info.queue.defer(getDomain, info);
          
          callback(null,null);
        });
      }
      
      function getDomain(info, callback) {
      
        d3.json("/pmapi/"+info.context+"/_fetch?names="+info.metric.name, function(json) {
          
          info.timestamp = json.timestamp;
          info.values = json.values[0].instances;
          
          info.queue.defer(getDomainDescription, info);
          
          callback(null,null);
        });
      }
      
      function getDomainDescription(info, callback) {
          
        d3.json("/pmapi/"+info.context+"/_indom?indom="+info.metric.indom, function(json) {
          
          info.names = json.instances;
          
          callback(null,null);
        });
      }
      
      function updateData() {
        var q = queue();
        var ctx = {queue: q, context: 0, metric: "kernel.all.load"};
        
        q.defer(getContext, ctx);
        
        q.await(function () {
          
          // map all the names and values 
          var map = d3.map();
          
          ctx.names.forEach(function(n) {
            map.set(n.instance, n.name);
          });
          
          ctx.values.forEach(function(v) {
            var n = map.get(v.instance);
            map.remove(v.instance);
            map.set(v.instance, {name: n, value: v.value});
          });
          
          ctx.instances = map.entries();
          
          var pcpMetric = {metric: ctx.metric, values: ctx.instances};
          
          d3.select('#content').html('<pre>'+JSON.stringify(pcpMetric, false, ' ')+'</pre>');
          
          // barchart
          xScale.domain(pcpMetric.values.map(xValue));
          yScale.domain([0, d3.max(pcpMetric.values, yValue)]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
              .selectAll("text")  
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-65)");
              
          svg.append("g")
              .attr("class", "y axis")
              .call(yAxis)
            .append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 6)
              .attr("dy", ".71em")
              .style("text-anchor", "end")
              .text(yAxisLabel);

          svg.selectAll(".bar")
              .data(pcpMetric.values)
            .enter().append("rect")
              .attr("class", "bar")
              .attr("x", xMap)
              .attr("width", xScale.rangeBand)
              .attr("y", yMap)
              .attr("height", function(d) { return height - yMap(d); });
        });
      }
      
      updateData();
      
    
    </script>
    
  </body>
</html>
